<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance Control - TradeMatch Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --emerald-500: #10b981;
            --emerald-600: #059669;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-300: #cbd5f5;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --red-500: #ef4444;
            --amber-500: #f59e0b;
            --blue-500: #3b82f6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: white;
            min-height: 100vh;
            display: grid;
            grid-template-columns: 280px 1fr;
        }
        aside { background: rgba(15, 23, 42, 0.85); padding: 24px; border-right: 1px solid rgba(255,255,255,0.08); }
        .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; }
        .logo-icon { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600)); display: grid; place-items: center; font-weight: 800; }
        .nav-section { margin-bottom: 24px; }
        .nav-section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.5); margin-bottom: 10px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 10px; color: white; text-decoration: none; opacity: 0.85; }
        .nav-item.active, .nav-item:hover { background: rgba(16, 185, 129, 0.15); opacity: 1; }
        main { padding: 32px 36px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title { font-size: 28px; font-weight: 800; }
        .badge { background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); padding: 6px 12px; border-radius: 999px; font-size: 12px; }
        .grid { display: grid; gap: 18px; }
        .grid.two { grid-template-columns: repeat(2, minmax(0,1fr)); }
        .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; }
        .card h3 { margin-bottom: 10px; }
        label { display: block; font-size: 13px; color: rgba(255,255,255,0.7); margin: 10px 0 6px; }
        input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(15,23,42,0.5); color: white; }
        button { background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600)); border: none; color: white; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        pre { background: rgba(15,23,42,0.6); padding: 14px; border-radius: 12px; overflow-x: auto; font-size: 12px; line-height: 1.4; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; }
        .muted { color: rgba(255,255,255,0.6); }
    </style>
</head>
<body>
    <aside>
        <div class="logo">
            <div class="logo-icon">T</div>
            <div>
                <div style="font-weight:800">TradeMatch</div>
                <div class="muted" style="font-size:12px">Finance Control</div>
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Overview</div>
            <a class="nav-item" href="admin-dashboard.html">üìä Dashboard</a>
            <a class="nav-item" href="admin-analytics.html">üìà Analytics</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Management</div>
            <a class="nav-item" href="admin-users.html">üë• Users</a>
            <a class="nav-item" href="admin-vendors.html">üîß Tradespeople</a>
            <a class="nav-item" href="admin-contracts.html">üìÑ Contracts</a>
            <a class="nav-item" href="admin-disputes.html">‚öñÔ∏è Disputes</a>
            <a class="nav-item" href="admin-quotes.html">üìã Quotes</a>
            <a class="nav-item" href="admin-bids.html">üíº Bids</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Moderation</div>
            <a class="nav-item" href="admin-reviews.html">‚≠ê Reviews</a>
            <a class="nav-item" href="admin-reports.html">üö® Reports</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Finance</div>
            <a class="nav-item active" href="admin-finance.html">üè¶ Finance Control</a>
            <a class="nav-item" href="admin-payments.html">üí≥ Payments</a>
            <a class="nav-item" href="admin-revenue.html">üí∞ Revenue</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">SEO & Growth</div>
            <a class="nav-item" href="admin-seo.html">üîç SEO Manager</a>
            <a class="nav-item" href="admin-content.html">üìù Content</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">System</div>
            <a class="nav-item" href="admin-admins.html">üë®‚Äçüíº Admins</a>
            <a class="nav-item" href="admin-audit.html">üìã Audit Log</a>
            <a class="nav-item" href="admin-settings.html">‚öôÔ∏è Settings</a>
            <a class="nav-item" href="admin-password-change.html">üîê Change Password</a>
        </div>
    </aside>

    <main>
        <div class="page-header">
            <div>
                <div class="page-title">Refund-Safe Finance Control</div>
                <div class="muted">Immutable ledger ‚Ä¢ Stripe-aware ‚Ä¢ Audit-ready</div>
            </div>
            <div class="badge" id="roleBadge">Role: loading...</div>
        </div>

        <div class="grid two">
            <div class="card">
                <h3>Issue Refund</h3>
                <label>Stripe Payment Intent ID</label>
                <input id="refundPaymentIntent" placeholder="pi_..." />
                <label>Amount (GBP)</label>
                <input id="refundAmount" placeholder="50.00" />
                <label>Reason Code</label>
                <select id="refundReason"></select>
                <label>Memo</label>
                <textarea id="refundMemo" rows="3"></textarea>
                <div style="margin-top:12px"><button id="refundBtn">Create Refund</button></div>
                <div class="muted" id="refundResult" style="margin-top:10px"></div>
            </div>
            <div class="card">
                <h3>Issue Vendor Credit</h3>
                <label>Vendor ID</label>
                <input id="creditVendorId" placeholder="vendor UUID" />
                <label>Amount (GBP)</label>
                <input id="creditAmount" placeholder="20.00" />
                <label>Origin</label>
                <select id="creditOrigin">
                    <option value="goodwill">Goodwill</option>
                    <option value="dispute_resolution">Dispute Resolution</option>
                    <option value="promo">Promo</option>
                </select>
                <label>Expiry Date</label>
                <input id="creditExpiry" type="date" />
                <label>Memo</label>
                <textarea id="creditMemo" rows="3"></textarea>
                <div style="margin-top:12px"><button id="creditBtn">Issue Credit</button></div>
                <div class="muted" id="creditResult" style="margin-top:10px"></div>
            </div>
        </div>

        <div class="grid two" style="margin-top:18px">
            <div class="card">
                <h3>Consume Vendor Credit</h3>
                <label>Vendor ID</label>
                <input id="consumeVendorId" placeholder="vendor UUID" />
                <label>Amount (GBP)</label>
                <input id="consumeAmount" placeholder="10.00" />
                <label>Used For</label>
                <input id="consumeUsedFor" placeholder="platform_fee" />
                <div style="margin-top:12px"><button id="consumeBtn">Consume Credit</button></div>
                <div class="muted" id="consumeResult" style="margin-top:10px"></div>
            </div>
            <div class="card">
                <h3>Reconciliation Report</h3>
                <div class="muted">Flags unresolved refunds and ledger totals.</div>
                <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button id="reconReportBtn">Load Report</button>
                    <button id="paymentReconBtn">Load Payment Recon</button>
                </div>
                <pre id="reconReport" style="margin-top:10px"></pre>
            </div>
        </div>

        <div class="grid" style="margin-top:18px">
            <div class="card">
                <h3>Ledger (Latest)</h3>
                <div class="muted" style="margin-bottom:10px">Append-only entries ‚Ä¢ No edits or deletes</div>
                <table>
                    <thead>
                        <tr>
                            <th>Entry ID</th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Amount (cents)</th>
                            <th>Reason</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody"></tbody>
                </table>
            </div>
        </div>

        <div class="grid two" style="margin-top:18px">
            <div class="card">
                <h3>Reconciliation</h3>
                <div class="muted" style="margin-bottom:10px">Compare Stripe totals vs internal ledger</div>
                <label>Start Date</label>
                <input id="reconStart" type="date" />
                <label>End Date</label>
                <input id="reconEnd" type="date" />
                <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button id="reconBtn">Run Ledger Reconciliation</button>
                    <button id="stripeReconBtn">Run Stripe Reconciliation</button>
                    <a id="exportRecon" class="nav-item" style="padding:8px 12px; background:rgba(59,130,246,0.2); border-radius:10px;" href="#">Export CSV</a>
                </div>
                <div class="muted" id="reconResult" style="margin-top:10px"></div>
            </div>
            <div class="card">
                <h3>Credit Expiry</h3>
                <div class="muted">Expire all credits past expiry date and record ledger entries.</div>
                <div style="margin-top:12px"><button id="expireCreditsBtn">Run Expiry</button></div>
                <div class="muted" id="expireResult" style="margin-top:10px"></div>
            </div>
        </div>

        <div class="grid two" style="margin-top:18px">
            <div class="card">
                <h3>Refund-Safe Flow Diagrams</h3>
                <pre>
A) Full Refund Flow

Stripe                Internal Ledger
  | PaymentIntent --------> ledger:charge
  |                        ledger:platform_fee
  | Finance Admin refund -> ledger:refund_initiated
  | Stripe refund webhook-> ledger:refund_succeeded
  | Reconcile totals ------> ledger:reconcile_snapshot

Idempotency: refund request + webhook event id

B) Partial Refund Flow

Stripe                Internal Ledger
  | Partial refund request -> ledger:refund_initiated
  | Refund webhook --------> ledger:refund_succeeded
  | Commission adj --------> ledger:fee_adjustment
  | Payout recalculated ---> ledger:payout_adjustment

C) Refund After Vendor Payout

Stripe                Internal Ledger
  | Refund after payout ---> ledger:refund_initiated
  | Refund webhook --------> ledger:refund_succeeded
  | Platform absorbs ------> ledger:platform_loss
  | Vendor balance flag ---> ledger:vendor_negative_adjustment
                </pre>
            </div>
            <div class="card">
                <h3>Scoring & Reconciliation</h3>
                <pre>
Vendor Scoring
- Refund: -2 points
- Partial refund: -1 point
- Chargeback: -10 points
- Recovery: +1 point per 30 days clean

Reconciliation
Daily = sum(ledger entries) vs Stripe balance transactions
Monthly = aggregated by currency & reason code
                </pre>
            </div>
        </div>
    </main>

    <script src="admin-api.js"></script>
    <script>
        const api = new AdminAPI();

        function requireRole() {
            if (!api.user) {
                window.location.href = 'admin-login.html';
                return;
            }
            const role = api.user.role || 'unknown';
            document.getElementById('roleBadge').textContent = `Role: ${role}`;
            if (!['super_admin', 'finance_admin'].includes(role)) {
                alert('Finance access required');
                window.location.href = 'admin-dashboard.html';
            }
        }

        async function loadReasons() {
            const data = await api.getFinanceReasonCodes();
            const select = document.getElementById('refundReason');
            data.reasons.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.code;
                opt.textContent = `${r.code} (${r.severity})`;
                select.appendChild(opt);
            });
        }

        async function loadLedger() {
            const data = await api.getLedger({ limit: 20 });
            const body = document.getElementById('ledgerBody');
            body.innerHTML = '';
            data.entries.forEach(entry => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${entry.id}</td>
                    <td>${entry.user_id || '-'}</td>
                    <td>${entry.entry_type}</td>
                    <td>${entry.amount_cents}</td>
                    <td>${entry.reason_code || '-'}</td>
                    <td>${new Date(entry.created_at).toLocaleString()}</td>
                `;
                body.appendChild(tr);
            });
        }

        document.getElementById('refundBtn').addEventListener('click', async () => {
            const payload = {
                stripePaymentIntentId: document.getElementById('refundPaymentIntent').value,
                amount: document.getElementById('refundAmount').value,
                reasonCode: document.getElementById('refundReason').value,
                memo: document.getElementById('refundMemo').value
            };
            const resultEl = document.getElementById('refundResult');
            try {
                const res = await api.createRefund(payload);
                resultEl.textContent = `Refund created: ${res.refundId}`;
                await loadLedger();
            } catch (err) {
                resultEl.textContent = err.message;
            }
        });

        document.getElementById('creditBtn').addEventListener('click', async () => {
            const payload = {
                vendorId: document.getElementById('creditVendorId').value,
                amount: document.getElementById('creditAmount').value,
                origin: document.getElementById('creditOrigin').value,
                expiresAt: document.getElementById('creditExpiry').value || null,
                memo: document.getElementById('creditMemo').value
            };
            const resultEl = document.getElementById('creditResult');
            try {
                const res = await api.issueVendorCredit(payload);
                resultEl.textContent = `Credit issued: ${res.creditId}`;
                await loadLedger();
            } catch (err) {
                resultEl.textContent = err.message;
            }
        });

        document.getElementById('consumeBtn').addEventListener('click', async () => {
            const payload = {
                vendorId: document.getElementById('consumeVendorId').value,
                amount: document.getElementById('consumeAmount').value,
                usedFor: document.getElementById('consumeUsedFor').value
            };
            const resultEl = document.getElementById('consumeResult');
            try {
                const res = await api.consumeVendorCredit(payload);
                resultEl.textContent = `Consumed ${res.consumed} cents, remaining ${res.remaining}`;
                await loadLedger();
            } catch (err) {
                resultEl.textContent = err.message;
            }
        });

        document.getElementById('reconReportBtn').addEventListener('click', async () => {
            const reportEl = document.getElementById('reconReport');
            try {
                const res = await api.getReconciliationReport({});
                reportEl.textContent = JSON.stringify(res, null, 2);
            } catch (err) {
                reportEl.textContent = err.message;
            }
        });

        document.getElementById('paymentReconBtn').addEventListener('click', async () => {
            const reportEl = document.getElementById('reconReport');
            try {
                const res = await api.getPaymentReconciliation();
                reportEl.textContent = JSON.stringify(res, null, 2);
            } catch (err) {
                reportEl.textContent = err.message;
            }
        });

        (async () => {
            requireRole();
            await loadReasons();
            await loadLedger();
        })();

        document.getElementById('reconBtn').addEventListener('click', async () => {
            const startDate = document.getElementById('reconStart').value;
            const endDate = document.getElementById('reconEnd').value;
            const resultEl = document.getElementById('reconResult');
            try {
                const res = await api.getReconciliation({ startDate, endDate });
                resultEl.textContent = `Ledger total (cents): ${res.ledgerTotalCents}`;
            } catch (err) {
                resultEl.textContent = err.message;
            }
        });

        document.getElementById('stripeReconBtn').addEventListener('click', async () => {
            const resultEl = document.getElementById('reconResult');
            try {
                const res = await api.getStripeReconciliation({ limit: 100 });
                resultEl.textContent = `Stripe totals (cents): ${JSON.stringify(res.stripeTotals)}`;
            } catch (err) {
                resultEl.textContent = err.message;
            }
        });

        document.getElementById('exportRecon').addEventListener('click', (e) => {
            e.preventDefault();
            const startDate = document.getElementById('reconStart').value;
            const endDate = document.getElementById('reconEnd').value;
            const query = new URLSearchParams({ startDate, endDate }).toString();
            window.location.href = `${API_CONFIG.BASE_URL}/api/admin/finance/reconciliation/export?${query}`;
        });

        const txExport = document.createElement('a');
        txExport.textContent = 'Export Tx CSV';
        txExport.href = '#';
        txExport.className = 'nav-item';
        txExport.style.padding = '8px 12px';
        txExport.style.background = 'rgba(59,130,246,0.2)';
        txExport.style.borderRadius = '10px';
        document.getElementById('exportRecon').parentElement.appendChild(txExport);
        txExport.addEventListener('click', (e) => {
            e.preventDefault();
            const startDate = document.getElementById('reconStart').value;
            const endDate = document.getElementById('reconEnd').value;
            const query = new URLSearchParams({ startDate, endDate }).toString();
            window.location.href = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.FINANCE_RECONCILIATION_TX_EXPORT}?${query}`;
        });

        const paymentExport = document.createElement('a');
        paymentExport.textContent = 'Export Payment CSV';
        paymentExport.href = '#';
        paymentExport.className = 'nav-item';
        paymentExport.style.padding = '8px 12px';
        paymentExport.style.background = 'rgba(59,130,246,0.2)';
        paymentExport.style.borderRadius = '10px';
        document.getElementById('exportRecon').parentElement.appendChild(paymentExport);
        paymentExport.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.FINANCE_RECONCILIATION_PAYMENTS_EXPORT}`;
        });

        document.getElementById('expireCreditsBtn').addEventListener('click', async () => {
            const resultEl = document.getElementById('expireResult');
            try {
                const res = await api.expireCredits();
                resultEl.textContent = `Expired credits: ${res.expiredCount}`;
                await loadLedger();
            } catch (err) {
                resultEl.textContent = err.message;
            }
        });
    </script>
</body>
</html>
